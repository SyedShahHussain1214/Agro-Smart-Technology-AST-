import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:math';
import 'package:flutter_tts/flutter_tts.dart';
import 'package:speech_to_text/speech_to_text.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:connectivity_plus/connectivity_plus.dart';
import 'package:confetti/confetti.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'package:image_picker/image_picker.dart';
import 'package:tflite_flutter/tflite_flutter.dart' as tfl;
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart' hide FieldValue;
import 'dart:io';
import 'package:image/image.dart' as img_lib;
import 'widgets/chat_bubble.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  await Hive.initFlutter();
  await Hive.openBox('offline_cache');
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Agro Smart Technology',
      theme: ThemeData(
        primarySwatch: Colors.green,
        fontFamily: 'NotoNastaliq',
        textTheme: const TextTheme(
          headlineLarge: TextStyle(fontSize: 28, fontWeight: FontWeight.bold),
          titleLarge: TextStyle(fontSize: 20, fontWeight: FontWeight.w600),
          bodyLarge: TextStyle(fontSize: 16),
          bodyMedium: TextStyle(fontSize: 14),
        ),
      ),
      darkTheme: ThemeData.dark(),
      themeMode: ThemeMode.system,
      home: const AuthScreen(),
    );
  }
}

class AuthScreen extends StatefulWidget {
  const AuthScreen({super.key});
  @override
  State<AuthScreen> createState() => _AuthScreenState();
}

class _AuthScreenState extends State<AuthScreen> {
  final _phoneController = TextEditingController();
  final _otpController = TextEditingController();
  String _verificationId = '';
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [
          TextField(controller: _phoneController, decoration: InputDecoration(hintText: 'ŸÅŸàŸÜ ŸÜŸÖÿ®ÿ± ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫ (+92)')),
          ElevatedButton(onPressed: _sendOtp, child: Text('OTP ÿ®⁄æ€åÿ¨€å⁄∫')),
          TextField(controller: _otpController, decoration: InputDecoration(hintText: 'OTP ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫')),
          ElevatedButton(onPressed: _verifyOtp, child: Text('ŸÑÿß⁄Ø ÿßŸÜ')),
        ]),
      ),
    );
  }

  void _sendOtp() async {
    final phone = _phoneController.text.trim();
    if (phone.isEmpty) {
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ŸÅŸàŸÜ ŸÜŸÖÿ®ÿ± ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫')));
      return;
    }
    try {
      debugPrint('üì± Sending OTP to: $phone');
      await FirebaseAuth.instance.verifyPhoneNumber(
        phoneNumber: phone,
        verificationCompleted: (credential) {
          debugPrint('‚úÖ Verification completed automatically');
          _verifyCredential(credential);
        },
        verificationFailed: (error) {
          debugPrint('‚ùå Verification failed: ${error.code} - ${error.message}');
          if (mounted) ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('ÿÆÿ±ÿßÿ®€å: ${error.message}')));
        },
        codeSent: (verificationId, resendToken) {
          debugPrint('‚úÖ OTP sent successfully. Verification ID: $verificationId');
          setState(() => _verificationId = verificationId);
          if (mounted) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('OTP ÿ®⁄æ€åÿ¨ ÿØ€åÿß ⁄Ø€åÿß €Å€í')));
        },
        codeAutoRetrievalTimeout: (verificationId) {
          debugPrint('‚è±Ô∏è Code auto retrieval timeout');
          setState(() => _verificationId = verificationId);
        },
        timeout: const Duration(minutes: 2),
      );
    } catch (e) {
      debugPrint('‚ùå Exception in _sendOtp: $e');
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('ÿÆÿ±ÿßÿ®€å: $e')));
    }
  }

  Future<void> _verifyCredential(PhoneAuthCredential credential) async {
    try {
      debugPrint('üîê Signing in with credential');
      await FirebaseAuth.instance.signInWithCredential(credential);
      if (mounted) {
        debugPrint('‚úÖ Sign in successful');
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const HomeScreen()));
      }
    } catch (e) {
      debugPrint('‚ùå Sign in failed: $e');
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('ŸÑÿß⁄Ø ÿßŸÜ ŸÜÿß⁄©ÿßŸÖ: $e')));
    }
  }

  void _verifyOtp() async {
    final otp = _otpController.text.trim();
    if (otp.isEmpty) {
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ OTP ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫')));
      return;
    }
    if (_verificationId.isEmpty) {
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Ÿæ€ÅŸÑ€í OTP ÿ®⁄æ€åÿ¨€å⁄∫')));
      return;
    }
    try {
      debugPrint('üîê Verifying OTP: $otp');
      final credential = PhoneAuthProvider.credential(verificationId: _verificationId, smsCode: otp);
      await _verifyCredential(credential);
    } catch (e) {
      debugPrint('‚ùå OTP verification failed: $e');
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('OTP ÿ∫ŸÑÿ∑ €Å€í: $e')));
    }
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});
  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> with TickerProviderStateMixin {
  final SpeechToText _speech = SpeechToText();
  final FlutterTts _tts = FlutterTts();
  final TextEditingController _controller = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  final ValueNotifier<List<Map<String, dynamic>>> _messages = ValueNotifier([]);
  // send button enabled state driven by controller + loading
  bool get _canSendText => _controller.text.trim().isNotEmpty && !_isLoading;
  bool _isListening = false;
  bool _isLoading = false;
  bool _isOnline = true;
  bool _speechReady = false;
  late ConfettiController _confettiController;
  late AnimationController _pulseController;
  late AnimationController _waveController;
  late Box _cacheBox;
  tfl.Interpreter? _interpreter;
  List<String> _labels = [];
  final ImagePicker _picker = ImagePicker();
  late String openWeatherKey;
  late String apiKey;
  
  // Initialize API keys - these should be set from environment or config
  void _initializeApiKeys() {
    // For production: Load from secure storage
    // For development: Load from .env file
    // Placeholder - replace with your keys locally
    openWeatherKey = 'bd0a7106c8a51f1eb7d128794e741c7f';
    apiKey = 'sk-proj-YOUR_KEY_HERE'; // Replace with your actual key
  }

  @override
  void initState() {
    super.initState();
    _confettiController = ConfettiController(duration: const Duration(seconds: 3));
    _pulseController = AnimationController(vsync: this, duration: const Duration(milliseconds: 1000))..repeat();
    _waveController = AnimationController(vsync: this, duration: const Duration(milliseconds: 1500))..repeat();
    _cacheBox = Hive.box('offline_cache');
    _initEverything();
    _controller.addListener(() { setState((){}); });
  }

  Future<void> _initEverything() async {
    _initializeApiKeys();
    await Permission.microphone.request();
    await Permission.camera.request();
    _speechReady = await _speech.initialize();
    await _tts.setLanguage("ur-PK");
    await _tts.setSpeechRate(0.45);
    _addMessage("ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑ€å⁄©ŸÖ ⁄©ÿ≥ÿßŸÜ ÿ®⁄æÿßÿ¶€å! üåæ‚ú®", false);
    await _tts.stop();
    await _tts.speak("ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑ€å⁄©ŸÖ ⁄©ÿ≥ÿßŸÜ ÿ®⁄æÿßÿ¶€åÿå ÿ≥ŸàÿßŸÑ ÿ®ŸàŸÑ€å⁄∫");
    _confettiController.play();
    await _loadModel();
    await _checkInternet();
    Connectivity().onConnectivityChanged.listen((result) {
      setState(() => _isOnline = result.contains(ConnectivityResult.none) == false);
    });
  }

  Future<void> _loadModel() async {
    try {
      _interpreter = await tfl.Interpreter.fromAsset('assets/models/plant_disease_model.tflite');
      _labels = (await rootBundle.loadString('assets/models/labels.txt')).split('\n');
    } catch (e) {
      debugPrint('Model load error: $e');
    }
  }

  Future<void> _checkInternet() async {
    var result = await Connectivity().checkConnectivity();
    setState(() => _isOnline = result.contains(ConnectivityResult.none) == false);
  }

  void _addMessage(String text, bool isUser) {
    final entry = {"text": text, "isUser": isUser, "time": DateTime.now()};
    _messages.value = List<Map<String, dynamic>>.from(_messages.value)..add(entry);
    // Scroll to bottom (ListView is reversed)
    Future.delayed(const Duration(milliseconds: 120), () {
      if (_scrollController.hasClients) {
        _scrollController.animateTo(
          0.0,
          duration: const Duration(milliseconds: 250),
          curve: Curves.easeOut,
        );
      }
    });
  }

  void _startListening() async {
    if (_isListening || !_speechReady) return;
    HapticFeedback.vibrate();
    setState(() => _isListening = true);
    await _speech.listen(
      onResult: (result) {
        if (result.finalResult && result.recognizedWords.isNotEmpty) {
          _controller.text = result.recognizedWords;
          _processVoiceCommand(result.recognizedWords);
        }
      },
      localeId: "ur-PK",
    );
  }

  void _stopListening() async {
    await _speech.stop();
    setState(() => _isListening = false);
    HapticFeedback.selectionClick();
  }

  void _processVoiceCommand(String query) async {
    final q = query.trim();
    if (q.isEmpty) return;
    _addMessage(q, true);
    if (q.contains('ŸÖŸàÿ≥ŸÖ')) {
      _askForCityAndFetchWeather();
    } else if (q.contains('ŸÖÿßÿ±⁄©€åŸπ') || q.contains('ÿ±€åŸπ')) {
      _getMarketPrices();
    } else if (q.contains('ÿ®€åŸÖÿßÿ±€å') || q.contains('⁄©€å⁄ë€í')) {
      _detectDisease();
    } else if (q.contains('ÿ≥⁄©€åŸÖ') || q.contains('ÿ≥ÿ®ÿ≥⁄à€å')) {
      _getGovernmentSchemes();
    } else if (q.contains('ÿ®ÿßÿ≤ÿßÿ±') || q.contains('ŸÅÿ±ŸàÿÆÿ™')) {
      Navigator.push(context, MaterialPageRoute(builder: (_) => const MarketplaceScreen()));
    } else {
      _sendToAI(q);
    }
  }

  void _sendMessageFromInput() {
    final text = _controller.text.trim();
    if (text.isEmpty || _isLoading) return;
    _controller.clear();
    _processVoiceCommand(text);
  }

  Future<void> _sendToAI(String q) async {
    if (!_isOnline) {
      final cacheKey = q.toLowerCase().trim();
      String? cached = _cacheBox.get(cacheKey);
      if (cached != null) {
        _addMessage(cached, false);
        await _tts.stop();
        await _tts.speak(cached);
        return;
      } else {
        _addMessage("ÿ¢ŸÅ ŸÑÿßÿ¶ŸÜ - ⁄©€å⁄Ü⁄à ÿ¨Ÿàÿßÿ® ŸÜ€Å€å⁄∫ €Å€í", false);
        return;
      }
    }

    if (mounted) setState(() => _isLoading = true);
    try {
      final res = await http.post(
        Uri.parse("https://api.openai.com/v1/chat/completions"),
        headers: {"content-type": "application/json", "authorization": "Bearer $apiKey"},
        body: jsonEncode({
          "model": "gpt-4o-mini",
          "messages": [
            {"role": "system", "content": "ÿ™ŸÖ ÿ™ÿ¨ÿ±ÿ®€Å ⁄©ÿßÿ± Ÿæÿß⁄©ÿ≥ÿ™ÿßŸÜ€å ⁄©ÿ≥ÿßŸÜ €ÅŸà€î ÿ¨Ÿàÿßÿ® ÿ≥ÿßÿØ€Å ÿßŸàÿ± ŸÖ⁄©ŸÖŸÑ ÿßÿ±ÿØŸà ŸÖ€å⁄∫ ÿØŸà€î IPM, ŸÅÿµŸÑ ⁄©€å ÿØ€å⁄©⁄æ ÿ®⁄æÿßŸÑ, ⁄©€å⁄ëŸà⁄∫ Ÿæÿ± ⁄©ŸÜŸπÿ±ŸàŸÑ."},
            {"role": "user", "content": q}
          ],
          "max_tokens": 300
        }),
      );

      if (res.statusCode == 200) {
        final answer = jsonDecode(res.body)["choices"][0]["message"]["content"];
        _addMessage(answer, false);
        await _tts.stop();
        await _tts.speak(answer);
        final cacheKey = q.toLowerCase().trim();
        _cacheBox.put(cacheKey, answer);
        _confettiController.play();
      }
    } catch (e) {
      _addMessage("ÿßŸÜŸπÿ±ŸÜ€åŸπ ⁄©ÿß ŸÖÿ≥ÿ¶ŸÑ€Å €Å€í: $e", false);
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  // NOTE: use `_getWeatherForCity(city)` for dynamic weather queries.

  Future<void> _askForCityAndFetchWeather() async {
    String city = 'Lahore';
    final controller = TextEditingController(text: city);
    final chosen = await showDialog<String?>(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('⁄©ŸàŸÜ ÿ≥ÿß ÿ¥€Åÿ±ÿü'),
        content: TextField(controller: controller, decoration: const InputDecoration(hintText: 'ŸÖÿ´ŸÑÿßŸã: Lahore €åÿß Multan')),
        actions: [
          TextButton(onPressed: () => Navigator.of(ctx).pop(null), child: const Text('ŸÖŸÜÿ≥ŸàÿÆ')),
          TextButton(onPressed: () => Navigator.of(ctx).pop(controller.text.trim()), child: const Text('ÿØÿ±€åÿßŸÅÿ™')),
        ],
      ),
    );

    if (chosen == null || chosen.isEmpty) {
      // user cancelled - fallback to Lahore
      await _getWeatherForCity('Lahore');
      return;
    }

    await _getWeatherForCity(chosen);
  }

  Future<void> _getWeatherForCity(String city) async {
    if (!_isOnline) return _addMessage("ÿ¢ŸÅ ŸÑÿßÿ¶ŸÜ - ŸÖŸàÿ≥ŸÖ ŸÜ€Å€å⁄∫ ÿØ€å⁄©⁄æ ÿ≥⁄©ÿ™ÿß", false);
    if (mounted) setState(() => _isLoading = true);
    try {
      final uri = Uri.parse('https://api.openweathermap.org/data/2.5/weather?q=${Uri.encodeComponent(city)},PK&appid=$openWeatherKey&lang=ur&units=metric');
      final res = await http.get(uri).timeout(const Duration(seconds: 10));
      if (res.statusCode != 200) throw Exception('HTTP ${res.statusCode}');
      final data = jsonDecode(res.body);
      String weather = 'ŸÖŸàÿ¨ŸàÿØ€Å ŸÖŸàÿ≥ŸÖ $city: ${data['weather'][0]['description']}, ÿØÿ±ÿ¨€Å ÿ≠ÿ±ÿßÿ±ÿ™: ${data['main']['temp']}¬∞C, ŸÜŸÖ€å: ${data['main']['humidity']}%';
      _addMessage(weather, false);
      await _tts.stop();
      await _tts.speak(weather);
    } catch (e) {
      _addMessage("ŸÖŸàÿ≥ŸÖ API ŸÖÿ≥ÿ¶ŸÑ€Å: $e", false);
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<void> _getMarketPrices() async {
    if (!_isOnline) return _addMessage("ÿ¢ŸÅ ŸÑÿßÿ¶ŸÜ - ŸÖÿßÿ±⁄©€åŸπ ÿ±€åŸπ ŸÜ€Å€å⁄∫ ÿØ€å⁄©⁄æ ÿ≥⁄©ÿ™ÿß", false);
    String mock = '⁄ØŸÜÿØŸÖ ⁄©ÿß ÿ±€åŸπ ŸÑÿß€ÅŸàÿ± ŸÖ€å⁄∫ 3000 ÿ±ŸàŸæ€í ŸÅ€å ŸÖŸÜ€î ⁄ÜÿßŸàŸÑ 5000 ÿ±ŸàŸæ€í€î (AMIS.pk ÿ≥€í)';
    _addMessage(mock, false);
    await _tts.stop();
    await _tts.speak(mock);
  }

  Future<void> _detectDisease() async {
    if (_interpreter == null) {
      _addMessage('ŸÖÿß⁄àŸÑ ŸÑŸà⁄à ŸÜ€Å€å⁄∫ €ÅŸàÿß€î ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ÿ®ÿπÿØ ŸÖ€å⁄∫ ⁄©Ÿàÿ¥ÿ¥ ⁄©ÿ±€å⁄∫€î', false);
      return;
    }
    await _tts.stop();
    await _tts.speak("⁄©€åŸÖÿ±€Å ⁄©⁄æŸàŸÑ€å⁄∫ ÿßŸàÿ± ŸÅÿµŸÑ ⁄©€å Ÿæÿ™€å ⁄©€å ÿ™ÿµŸà€åÿ± ŸÑ€å⁄∫€î");
    final XFile? image = await _picker.pickImage(source: ImageSource.camera);
    if (image == null) return;
    if (mounted) setState(() => _isLoading = true);
    try {
      final imgBytes = await File(image.path).readAsBytes();
      var input = await _preprocessImage(imgBytes);
      // output shape [1, num_labels]
      var output = List.generate(1, (_) => List<double>.filled(_labels.length, 0.0));
      _interpreter!.run(input, output);
      double maxScore = output[0].reduce(max);
      int maxIndex = output[0].indexOf(maxScore);
      String disease = (maxIndex >= 0 && maxIndex < _labels.length) ? _labels[maxIndex] : 'ŸÜÿßŸÖÿπŸÑŸàŸÖ';
      String advice = 'ÿ®€åŸÖÿßÿ±€å: $disease€î IPM: ŸÜÿßŸÖ€åÿßÿ™€å ÿ∑ÿ±€åŸÇ€í ÿßŸæŸÜÿßÿ¶€å⁄∫ €åÿß ŸÖÿß€Åÿ± ÿ≥€í ŸÖÿ¥Ÿàÿ±€Å ŸÑ€å⁄∫€î';
      _addMessage(advice, false);
      await _tts.stop();
      await _tts.speak(advice);
    } catch (e) {
      _addMessage("ÿ®€åŸÖÿßÿ±€å ⁄Ü€å⁄© ŸÖÿ≥ÿ¶ŸÑ€Å: $e", false);
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<List<List<List<List<double>>>>> _preprocessImage(Uint8List imageBytes) async {
    img_lib.Image? image = img_lib.decodeImage(imageBytes);
    if (image == null) throw Exception('Invalid image');
    image = img_lib.copyResize(image, width: 224, height: 224);
    // return shape [1][height][width][3]
    final List<List<List<List<double>>>> input = List.generate(1, (_) =>
        List.generate(224, (y) => List.generate(224, (x) {
              final pixel = image!.getPixel(x, y);
              return [pixel.r / 255.0, pixel.g / 255.0, pixel.b / 255.0];
            })));
    return input;
  }

  void _getGovernmentSchemes() {
    String schemes = '2025 ÿ≥⁄©€åŸÖ€å⁄∫: ⁄Øÿ±€åŸÜ Ÿæÿß⁄©ÿ≥ÿ™ÿßŸÜ ÿßŸÜ€åÿ¥€åŸπŸà (⁄©ÿßÿ±ŸæŸàÿ±€åŸπ ŸÅÿßÿ±ŸÖÿ≤)ÿå ÿ±ÿ≥⁄© ⁄©Ÿàÿ±€åÿ¨ ÿ≥⁄©€åŸÖ (3 ŸÖŸÑ€åŸÜ ÿ™⁄© ŸÑŸàŸÜ)ÿå ÿ≥ÿßŸÅŸπ ŸÑŸàŸÜÿ≤ ŸÅÿßÿ±ŸÖÿ±ÿ≤ ⁄©€í ŸÑ€å€í€î';
    _addMessage(schemes, false);
    _tts.speak(schemes);
  }
  
  void _showInfoSheet(String title, String content) {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text(title),
        content: SingleChildScrollView(child: Text(content)),
        actions: [TextButton(onPressed: () => Navigator.of(context).pop(), child: const Text('Close'))],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(children: [
        NestedScrollView(
          headerSliverBuilder: (context, innerScrolled) {
            return [
              SliverAppBar(
                expandedHeight: 220,
                pinned: false,
                floating: false,
                stretch: true,
                backgroundColor: Colors.green[800],
                flexibleSpace: FlexibleSpaceBar(
                  titlePadding: const EdgeInsetsDirectional.only(start: 16, bottom: 12),
                  centerTitle: false,
                  title: Text('Agro Smart Technology', style: const TextStyle(fontSize: 18)),
                  background: Container(
                    decoration: BoxDecoration(gradient: LinearGradient(colors: [Colors.green[800]!, Colors.green[600]!]), borderRadius: const BorderRadius.vertical(bottom: Radius.circular(40))),
                    child: SafeArea(
                      child: Padding(
                        padding: const EdgeInsets.only(top: 24, left: 16, right: 16, bottom: 12),
                        child: Column(mainAxisAlignment: MainAxisAlignment.start, crossAxisAlignment: CrossAxisAlignment.start, children: [
                          Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [
                            SizedBox(
                              height: 84,
                              child: Image.asset('assets/icons/icon.png', fit: BoxFit.contain, cacheWidth: 240, cacheHeight: 220),
                            ),
                            PopupMenuButton<String>(
                              icon: const Icon(Icons.more_vert, color: Colors.white),
                              onSelected: (value) {
                                if (value == 'info') {
                                  _showInfoSheet('App Info', 'Agro Smart Technology\nVersion: 1.0.1\nDesigned to help Pakistani farmers with weather, market prices, disease detection and AI advice.');
                                } else if (value == 'features') {
                                  _showInfoSheet('Features', '‚Ä¢ Voice and text chat in Urdu\n‚Ä¢ Weather and market rates\n‚Ä¢ Plant disease detection via camera\n‚Ä¢ Offline caching of answers\n‚Ä¢ Text-to-speech replies');
                                } else if (value == 'model') {
                                  _showInfoSheet('Model Used', 'This app uses OpenAI chat completions (model: gpt-4o-mini) for conversational advice.');
                                } else if (value == 'howto') {
                                  _showInfoSheet('How to Use', 'Tap the mic for speech input, or type a question and press send. Ask about ŸÖŸàÿ≥ŸÖ, ŸÖÿßÿ±⁄©€åŸπ, ÿ®€åŸÖÿßÿ±€å, or general farming questions in Urdu.');
                                } else if (value == 'dev') {
                                  _showInfoSheet('Developer', 'Syed Shah Hussain (Lead Developer)\nContact: S2024387008@umt.edu.pk');
                                } else if (value == 'about') {
                                  _showInfoSheet('About Us', 'Agro Smart Technology is a student project aimed at providing AI-powered agricultural assistance to smallholder farmers.');
                                }
                              },
                              itemBuilder: (context) => [
                                const PopupMenuItem(value: 'info', child: Text('App Info')),
                                const PopupMenuItem(value: 'features', child: Text('App Features')),
                                const PopupMenuItem(value: 'model', child: Text('Which Model')),
                                const PopupMenuItem(value: 'howto', child: Text('How to Use')),
                                const PopupMenuItem(value: 'dev', child: Text('Developer')),
                                const PopupMenuItem(value: 'about', child: Text('About Us')),
                              ],
                            ),
                          ]),
                          const SizedBox(height: 8),
                          const Text('ÿ¢Ÿæ ⁄©ÿß ÿ∞ÿßÿ™€å ÿ≤ÿ±ÿπ€å ŸÖÿ¥€åÿ±', style: TextStyle(fontSize: 16, color: Colors.white70)),
                          const SizedBox(height: 8),
                          Row(children: [
                            Icon(_isOnline ? Icons.wifi : Icons.wifi_off, color: _isOnline ? Colors.lightGreen : Colors.red),
                            const SizedBox(width: 8),
                            Text(_isOnline ? 'ÿ¢ŸÜ ŸÑÿßÿ¶ŸÜ' : 'ÿ¢ŸÅ ŸÑÿßÿ¶ŸÜ', style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                          ])
                        ]),
                      ),
                    ),
                  ),
                ),
              ),
            ];
          },
          body: Column(children: [
            Expanded(
              child: ValueListenableBuilder<List<Map<String, dynamic>>>(
                valueListenable: _messages,
                builder: (context, messages, _) {
                  return SafeArea(
                    top: false,
                    bottom: false,
                    child: ListView.builder(
                      controller: _scrollController,
                      padding: const EdgeInsets.all(16),
                      reverse: true,
                      itemCount: messages.length + (_isLoading ? 1 : 0),
                      itemBuilder: (_, i) {
                        if (_isLoading && i == 0) {
                          return Align(
                            alignment: Alignment.centerLeft,
                            child: Container(
                              margin: const EdgeInsets.symmetric(vertical: 8),
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(color: Theme.of(context).brightness == Brightness.dark ? Colors.grey[800] : Colors.grey[200], borderRadius: BorderRadius.circular(16)),
                              child: Row(mainAxisSize: MainAxisSize.min, children: const [Text('ÿ≥Ÿà⁄Ü ÿ±€Åÿß €ÅŸà⁄∫'), SizedBox(width: 10), SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2))]),
                            ),
                          );
                        }

                        int effectiveIndex = i;
                        if (_isLoading) effectiveIndex = i - 1;
                        final msg = messages[messages.length - 1 - effectiveIndex];
                        final isUser = msg['isUser'] as bool;
                        final text = msg['text'] as String;
                        final time = msg['time'] as DateTime;

                        return ChatBubble(text: text, isUser: isUser, time: time);
                      },
                    ),
                  );
                },
              ),
            ),
            SafeArea(
              top: false,
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
                decoration: BoxDecoration(color: Theme.of(context).scaffoldBackgroundColor, boxShadow: const [BoxShadow(color: Colors.black12, blurRadius: 8)]),
                child: Row(children: [
                  GestureDetector(onTapDown: (_) => _startListening(), onTapUp: (_) => _stopListening(), onTapCancel: _stopListening, child: Container(width: 56, height: 56, decoration: BoxDecoration(shape: BoxShape.circle, color: _isListening ? Colors.redAccent : Theme.of(context).colorScheme.primary), child: Icon(_isListening ? Icons.mic : Icons.mic_none, color: Colors.white))),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 12),
                      decoration: BoxDecoration(color: Theme.of(context).brightness == Brightness.dark ? const Color(0xFF0D1926) : Colors.white, borderRadius: BorderRadius.circular(28), boxShadow: const [BoxShadow(color: Colors.black12, blurRadius: 6)]),
                      child: Row(children: [
                        Expanded(child: TextField(controller: _controller, minLines: 1, maxLines: 5, style: const TextStyle(fontSize: 16), decoration: const InputDecoration.collapsed(hintText: 'ÿ≥ŸàÿßŸÑ ŸÑ⁄©⁄æ€å⁄∫ €åÿß ŸÖÿßÿ¶€å⁄© ÿØÿ®ÿßÿ¶€å⁄∫...'))),
                        IconButton(onPressed: _canSendText ? _sendMessageFromInput : null, icon: Icon(Icons.send, color: _canSendText ? Theme.of(context).colorScheme.primary : Theme.of(context).disabledColor)),
                      ]),
                    ),
                  ),
                  const SizedBox(width: 8),
                  IconButton(onPressed: () async {
                    if (!_isOnline) {
                      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('⁄©€åŸÖÿ±€Å ÿßÿ≥⁄©€åŸÜ ⁄©€í ŸÑ€å€í ÿßŸÜŸπÿ±ŸÜ€åŸπ ÿ∂ÿ±Ÿàÿ±€å €Å€í')));
                    }
                    await _detectDisease();
                  }, icon: Icon(Icons.camera_alt, color: Theme.of(context).iconTheme.color)),
                ]),
              ),
            ),
          ]),
        ),
        Align(alignment: Alignment.topCenter, child: ConfettiWidget(confettiController: _confettiController, blastDirection: pi / 2, emissionFrequency: 0.05, numberOfParticles: 50, gravity: 0.1)),
      ]),
    );
  }

  @override
  void dispose() {
    _confettiController.dispose();
    _pulseController.dispose();
    _waveController.dispose();
    _interpreter?.close();
    _scrollController.dispose();
    _messages.dispose();
    super.dispose();
  }
}

class MarketplaceScreen extends StatefulWidget {
  const MarketplaceScreen({super.key});
  @override
  State<MarketplaceScreen> createState() => _MarketplaceScreenState();
}

class _MarketplaceScreenState extends State<MarketplaceScreen> {
  final _tts = FlutterTts();
  final _speech = SpeechToText();
  String _product = '';
  String _price = '';
  String _quantity = '';
  List<Map> _listings = [];

  @override
  void initState() {
    super.initState();
    _tts.setLanguage("ur-PK");
    _loadListings();
    _tts.speak("Ÿæÿ±Ÿà⁄à⁄©Ÿπ ⁄©ÿß ŸÜÿßŸÖÿå ŸÖŸÇÿØÿßÿ±ÿå ŸÇ€åŸÖÿ™ ÿ®ŸàŸÑ€å⁄∫€î");
    _startListeningForListing();
  }

  void _startListeningForListing() async {
    await _speech.listen(onResult: (result) {
      if (result.finalResult) {
        _product = '⁄ØŸÜÿØŸÖ'; // Parse better with logic
        _quantity = '10 ŸÖŸÜ';
        _price = '3000 ÿ±ŸàŸæ€í';
        _addListing();
      }
    }, localeId: "ur-PK");
  }

  void _addListing() async {
    await FirebaseFirestore.instance.collection('listings').add({
      'userId': FirebaseAuth.instance.currentUser?.uid,
      'product': _product,
      'quantity': _quantity,
      'price': _price,
      'timestamp': DateTime.now(),
    });
    _tts.speak("ŸÑŸêÿ≥ŸπŸÜ⁄Ø ÿ¥ÿßŸÖŸÑ €ÅŸà ⁄Øÿ¶€å€î");
    _loadListings();
  }

  void _loadListings() async {
    final snapshot = await FirebaseFirestore.instance.collection('listings').get();
    setState(() => _listings = snapshot.docs.map((doc) => doc.data()).toList());
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('⁄à€åÿ¨€åŸπŸÑ ŸÖÿßÿ±⁄©€åŸπ ŸæŸÑ€åÿ≥')),
      body: ListView.builder(
        itemCount: _listings.length,
        itemBuilder: (_, i) {
          var listing = _listings[i];
          return ListTile(
            title: Text('${listing['product']} - ${listing['quantity']} - ${listing['price']}'),
            trailing: ElevatedButton(onPressed: () => _tts.speak(listing['product']), child: Text('ÿ≥ŸÜŸà')),
          );
        },
      ),
      floatingActionButton: FloatingActionButton(onPressed: _startListeningForListing, child: Icon(Icons.mic)),
    );
  }
}